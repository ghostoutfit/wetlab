<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wetlab Database</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }

        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        label {
            font-weight: 600;
            font-size: 14px;
            color: #555;
        }

        select, input[type="text"] {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            min-width: 200px;
        }

        button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.2s;
        }

        button:hover {
            background: #0056b3;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .stats {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 14px;
            color: #666;
        }

        .entries-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .entry-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            background: white;
            transition: box-shadow 0.2s;
        }

        .entry-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .entry-header {
            margin-bottom: 10px;
        }

        .entry-category {
            display: inline-block;
            background: #007bff;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 5px;
            margin-bottom: 5px;
        }

        .entry-type {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .entry-specific {
            font-weight: 600;
            color: #333;
            margin: 10px 0 5px 0;
            font-size: 16px;
        }

        .entry-description {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .entry-video {
            margin-top: 15px;
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
            border-radius: 4px;
        }

        .entry-video iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }

        .entry-meta {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            font-size: 12px;
            color: #888;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 18px;
        }

        .sort-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Wetlab Experiments Database</h1>

        <div class="controls">
            <div class="control-group">
                <label for="categoryFilter">Filter by Category:</label>
                <select id="categoryFilter">
                    <option value="">All Categories</option>
                </select>
            </div>

            <div class="control-group">
                <label for="typeFilter">Filter by Type:</label>
                <select id="typeFilter">
                    <option value="">All Types</option>
                </select>
            </div>

            <div class="control-group">
                <label for="safetyFilter">Filter by Safety Level:</label>
                <select id="safetyFilter">
                    <option value="">All Safety Levels</option>
                </select>
            </div>

            <div class="control-group">
                <label for="searchBox">Search:</label>
                <input type="text" id="searchBox" placeholder="Search description or specific...">
            </div>

            <div class="control-group">
                <label for="sortBy">Sort by:</label>
                <select id="sortBy">
                    <option value="category">Category</option>
                    <option value="specific">Specific</option>
                    <option value="type">Type</option>
                    <option value="safety">Safety Level</option>
                </select>
            </div>

            <div class="control-group">
                <label>&nbsp;</label>
                <button id="refreshBtn">üîÑ Refresh Data</button>
            </div>
        </div>

        <div class="stats" id="stats"></div>

        <div id="errorContainer"></div>
        <div id="loadingContainer" class="loading">Loading data...</div>
        <div id="entriesContainer" class="entries-grid"></div>
    </div>

    <script>
        // Google Sheet CSV URL
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR77LLOhSqJaEE3fvG35AMB1EUmAlb2r4bzEQA8YVf5IpX_orSDqzjX-LzSgxaCUDUrVh5hjoJH1TVe/pub?output=csv';

        let allEntries = [];
        let filteredEntries = [];

        // Extract YouTube video ID from various URL formats
        function getYouTubeId(url) {
            if (!url) return null;

            const patterns = [
                /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/shorts\/)([^&\?\/]+)/,
                /youtube\.com\/embed\/([^&\?\/]+)/
            ];

            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match) return match[1];
            }
            return null;
        }

        // Parse CSV data
        function parseCSV(csv) {
            const lines = csv.split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
            const entries = [];

            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;

                // Handle CSV with quoted fields containing commas
                const row = [];
                let currentField = '';
                let inQuotes = false;

                for (let j = 0; j < lines[i].length; j++) {
                    const char = lines[i][j];

                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        row.push(currentField.trim().replace(/^"|"$/g, ''));
                        currentField = '';
                    } else {
                        currentField += char;
                    }
                }
                row.push(currentField.trim().replace(/^"|"$/g, ''));

                const entry = {};
                headers.forEach((header, index) => {
                    entry[header] = row[index] || '';
                });

                // Only include entries with YouTube links
                const youtubeLink = entry['YouTube or Image Link'] || '';
                if (youtubeLink && getYouTubeId(youtubeLink)) {
                    entries.push(entry);
                }
            }

            return entries;
        }

        // Fetch data from Google Sheet
        async function fetchData() {
            const loadingContainer = document.getElementById('loadingContainer');
            const errorContainer = document.getElementById('errorContainer');
            const refreshBtn = document.getElementById('refreshBtn');

            loadingContainer.style.display = 'block';
            errorContainer.innerHTML = '';
            refreshBtn.disabled = true;

            try {
                const response = await fetch(SHEET_URL);
                if (!response.ok) throw new Error('Failed to fetch data');

                const csv = await response.text();
                allEntries = parseCSV(csv);

                populateFilters();
                applyFilters();
                loadingContainer.style.display = 'none';
                refreshBtn.disabled = false;
            } catch (error) {
                console.error('Error fetching data:', error);
                errorContainer.innerHTML = `<div class="error">Error loading data: ${error.message}. Please try again.</div>`;
                loadingContainer.style.display = 'none';
                refreshBtn.disabled = false;
            }
        }

        // Populate filter dropdowns
        function populateFilters() {
            const categories = new Set();
            const types = new Set();
            const safetyLevels = new Set();

            allEntries.forEach(entry => {
                // Handle multiple categories separated by commas
                const categoryStr = entry['Category'] || '';
                categoryStr.split(',').forEach(cat => {
                    const trimmed = cat.trim();
                    if (trimmed) categories.add(trimmed);
                });

                const type = entry['Type'] || '';
                if (type) types.add(type);

                const safety = entry['Safety'] || '';
                if (safety) safetyLevels.add(safety);
            });

            // Populate category filter
            const categoryFilter = document.getElementById('categoryFilter');
            categoryFilter.innerHTML = '<option value="">All Categories</option>';
            Array.from(categories).sort().forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categoryFilter.appendChild(option);
            });

            // Populate type filter
            const typeFilter = document.getElementById('typeFilter');
            typeFilter.innerHTML = '<option value="">All Types</option>';
            Array.from(types).sort().forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                typeFilter.appendChild(option);
            });

            // Populate safety filter
            const safetyFilter = document.getElementById('safetyFilter');
            safetyFilter.innerHTML = '<option value="">All Safety Levels</option>';
            Array.from(safetyLevels).sort((a, b) => a - b).forEach(safety => {
                const option = document.createElement('option');
                option.value = safety;
                option.textContent = `Level ${safety}`;
                safetyFilter.appendChild(option);
            });
        }

        // Apply filters and sorting
        function applyFilters() {
            const categoryFilter = document.getElementById('categoryFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const safetyFilter = document.getElementById('safetyFilter').value;
            const searchBox = document.getElementById('searchBox').value.toLowerCase();
            const sortBy = document.getElementById('sortBy').value;

            filteredEntries = allEntries.filter(entry => {
                // Category filter (check if any of the entry's categories match)
                if (categoryFilter) {
                    const entryCategories = (entry['Category'] || '').split(',').map(c => c.trim());
                    if (!entryCategories.includes(categoryFilter)) return false;
                }

                // Type filter
                if (typeFilter && entry['Type'] !== typeFilter) return false;

                // Safety filter
                if (safetyFilter && entry['Safety'] !== safetyFilter) return false;

                // Search filter
                if (searchBox) {
                    const description = (entry['Description'] || '').toLowerCase();
                    const specific = (entry['Specific'] || '').toLowerCase();
                    const category = (entry['Category'] || '').toLowerCase();
                    if (!description.includes(searchBox) &&
                        !specific.includes(searchBox) &&
                        !category.includes(searchBox)) {
                        return false;
                    }
                }

                return true;
            });

            // Sort entries
            filteredEntries.sort((a, b) => {
                let aVal, bVal;

                switch(sortBy) {
                    case 'category':
                        aVal = a['Category'] || '';
                        bVal = b['Category'] || '';
                        break;
                    case 'specific':
                        aVal = a['Specific'] || '';
                        bVal = b['Specific'] || '';
                        break;
                    case 'type':
                        aVal = a['Type'] || '';
                        bVal = b['Type'] || '';
                        break;
                    case 'safety':
                        aVal = parseInt(a['Safety']) || 0;
                        bVal = parseInt(b['Safety']) || 0;
                        return aVal - bVal;
                    default:
                        return 0;
                }

                return aVal.localeCompare(bVal);
            });

            renderEntries();
            updateStats();
        }

        // Render entries
        function renderEntries() {
            const container = document.getElementById('entriesContainer');

            if (filteredEntries.length === 0) {
                container.innerHTML = '<div class="no-results">No experiments found matching your filters.</div>';
                return;
            }

            container.innerHTML = filteredEntries.map(entry => {
                const youtubeLink = entry['YouTube or Image Link'] || '';
                const videoId = getYouTubeId(youtubeLink);
                const categories = (entry['Category'] || '').split(',').map(c => c.trim());

                return `
                    <div class="entry-card">
                        <div class="entry-header">
                            ${categories.map(cat =>
                                `<span class="entry-category">${cat}</span>`
                            ).join('')}
                            ${entry['Type'] ? `<span class="entry-type">${entry['Type']}</span>` : ''}
                        </div>
                        <div class="entry-specific">${entry['Specific'] || 'Untitled'}</div>
                        <div class="entry-description">${entry['Description'] || ''}</div>
                        ${videoId ? `
                            <div class="entry-video">
                                <iframe
                                    src="https://www.youtube.com/embed/${videoId}"
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                    allowfullscreen>
                                </iframe>
                            </div>
                        ` : ''}
                        <div class="entry-meta">
                            ${entry['Safety'] ? `<span>üõ°Ô∏è Safety: Level ${entry['Safety']}</span>` : ''}
                            ${entry['Example Phenomena'] ? `<span>üìä ${entry['Example Phenomena']}</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update statistics
        function updateStats() {
            const stats = document.getElementById('stats');
            stats.textContent = `Showing ${filteredEntries.length} of ${allEntries.length} experiments with video demonstrations`;
        }

        // Event listeners
        document.getElementById('categoryFilter').addEventListener('change', applyFilters);
        document.getElementById('typeFilter').addEventListener('change', applyFilters);
        document.getElementById('safetyFilter').addEventListener('change', applyFilters);
        document.getElementById('searchBox').addEventListener('input', applyFilters);
        document.getElementById('sortBy').addEventListener('change', applyFilters);
        document.getElementById('refreshBtn').addEventListener('click', fetchData);

        // Initial load
        fetchData();
    </script>
</body>
</html>
